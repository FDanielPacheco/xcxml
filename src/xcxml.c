/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Introduction
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/**********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************//**
 * @file      xcxml.c
 * 
 * @version   1.0.0
 *
 * @date      01-10-2025
 *
 * @brief     A wrapper function designed to parse xml descriptors easily.  
 *  
 * @author    Fábio D. Pacheco, 
 * @email     fabio.d.pacheco@inesctec.pt or pacheco.castro.fabio@gmail.com
 *
 * @copyright Copyright (c) [2025] [Fábio D. Pacheco]
 * 
 * @note      Manuals:
 *            https://gnome.pages.gitlab.gnome.org/libxml2/html/
 * 
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Imported libraries
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

#include <string.h>
#include <errno.h>
#include <libxml2/libxml/xpath.h>

#include "xcxml.h"

/**************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
int8_t 
xml_get_value( 
  const char * file_path, 
  const char * key_tree, 
  char * buf, 
  size_t buf_len 
){
  int8_t ret = -1;
  errno = 0;

  if( !file_path || !key_tree || !buf || !buf_len ){
    errno = EINVAL;
    return ret;
  }

  xmlDoc * doc = xmlReadFile( 
    file_path, 
    NULL, 
    0 
  );
  
  if( !doc ){
    errno = ENOENT;
    return ret;
  }
  
  xmlXPathContextPtr context = xmlXPathNewContext( doc );
  if( !context ){
    errno = ENOENT;
    return ret;
  }
  
  xmlXPathObjectPtr result = xmlXPathEvalExpression(
    (xmlChar*) key_tree, 
    context
  );

  xmlNodeSetPtr node = result->nodesetval;

  if( node && 0 < node->nodeNr ){
    xmlChar * content = xmlNodeGetContent( node->nodeTab[0] );
    if( content ){
      if( NULL != strncpy( buf, (const char *) content, buf_len - 1) )
        ret = 0;
      (void) xmlFree( content );
    }
  }

  (void) xmlXPathFreeObject( result );
  (void) xmlXPathFreeContext( context );
  (void) xmlFreeDoc( doc );
  return ret;
}

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * End of file
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
