/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Introduction
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/**********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************//**
 * @file      xcxml.c
 * 
 * @version   1.0.0
 *
 * @date      01-10-2025
 *
 * @brief     A wrapper function designed to parse xml descriptors easily.  
 *  
 * @author    Fábio D. Pacheco, 
 * @email     fabio.d.pacheco@inesctec.pt or pacheco.castro.fabio@gmail.com
 *
 * @copyright Copyright (c) [2025] [Fábio D. Pacheco]
 * 
 * @note      Manuals:
 *            https://gnome.pages.gitlab.gnome.org/libxml2/html/
 * 
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Imported libraries
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

#include <string.h>
#include <errno.h>
#include <libxml2/libxml/xpath.h>
#include <linux/limits.h>

#include "xcxml.h"

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Function prototypes
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/**********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************//**
 * @brief The function
 *  
 * @param[in] field The field structure being read.
 * @param[in] buf The value inside the field chosen.
 * @param[out] agr The data structured that will be filled.
 * 
 * @return Upon success, it fills the `arg` variable at the field.value.offset with field.value.size length bytes, and it returns 0. \n
 * Otherwise, -1 is returned, and errno is set to indicate the error.
 *
 *  - `EINVAL`: Invalid argument \n
 * 
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
int8_t xml_set_field( 
  const xml_field_t * field, 
  const char * buf, 
  void * arg
 );

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Function definitions
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/**************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
int8_t 
xml_get_value( 
  const char * file_path, 
  const char * key_tree, 
  char * buf, 
  size_t buf_len 
){
  int8_t ret = -1;
  errno = 0;

  if( !file_path || !key_tree || !buf || !buf_len ){
    errno = EINVAL;
    return ret;
  }

  xmlDoc * doc = xmlReadFile( 
    file_path, 
    NULL, 
    0 
  );
  
  if( !doc ){
    errno = ENOENT;
    return ret;
  }
  
  xmlXPathContextPtr context = xmlXPathNewContext( doc );
  if( !context ){
    errno = ENOENT;
    return ret;
  }
  
  xmlXPathObjectPtr result = xmlXPathEvalExpression(
    (xmlChar*) key_tree, 
    context
  );

  xmlNodeSetPtr node = result->nodesetval;

  if( node && 0 < node->nodeNr ){
    xmlChar * content = xmlNodeGetContent( node->nodeTab[0] );
    if( content ){
      if( NULL != strncpy( buf, (const char *) content, buf_len - 1) )
        ret = 0;
      (void) xmlFree( content );
    }
  }

  (void) xmlXPathFreeObject( result );
  (void) xmlXPathFreeContext( context );
  (void) xmlFreeDoc( doc );
  return ret;
}

/**************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
int8_t 
xml_set_field( 
  const xml_field_t * field, 
  const char * buf, 
  void * arg
){

  if( !field || !arg || !buf ){
    errno = EINVAL;
    return -1;
  }

  size_t offset = field->value.offset;
  size_t size = field->value.size;

  memcpy( 
    (char *) arg + offset,
    buf,
    size
  );
  
  return 0;
}

/**************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
int8_t 
xml_retrive_data( 
  const char * file_path, 
  const xml_field_t * xml_fields, 
  size_t n_fields, 
  void * args,  
  size_t args_size
){
  if( !file_path || !xml_fields || !args ){
    errno = EINVAL;
    return -1;
  }

  char xml_buf[ NAME_MAX ];
  
  for( size_t i = 0 ; i < n_fields ; ++i ){
    const xml_field_t * field = &xml_fields[i];
    
    int8_t xml_ret = xml_get_value(
      file_path,
      field->name,
      xml_buf,
      sizeof(xml_buf)
    ); 

    if( !xml_ret ){
      if( args_size - field->value.offset < field->value.size ){
        errno = ENOMEM;
        return -1;
      }

      xml_set_field( 
        field,
        xml_buf,
        args
      );   
    }

    memset( 
      xml_buf, 
      0, 
      sizeof(xml_buf)
    );
  }  

  return 0;
}


/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * End of file
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
